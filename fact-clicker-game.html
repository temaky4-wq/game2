<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∞–±—Ä–∏–∫–∞ –§–∞–∫—Ç–æ–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* –°—á—ë—Ç—á–∏–∫ –∑–Ω–∞–Ω–∏–π */
        .knowledge-display {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .knowledge-amount {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .knowledge-per-sec {
            font-size: 16px;
            opacity: 0.9;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∫–ª–∏–∫–∞ */
        .click-button {
            width: 180px;
            height: 180px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        .click-button:active {
            transform: scale(0.95);
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255,255,255,0.3);
            font-weight: bold;
        }

        /* –°–µ–∫—Ü–∏–∏ */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ñ–∞–∫—Ç–æ–≤ */
        .card-item {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-info {
            flex: 1;
        }

        .card-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-stats {
            font-size: 13px;
            opacity: 0.9;
        }

        .card-count {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 3px;
        }

        .card-buy-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .card-buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        .leaderboard-item {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .leader-rank {
            font-size: 20px;
            font-weight: bold;
            min-width: 30px;
        }

        .leader-info {
            flex: 1;
        }

        .leader-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leader-score {
            font-size: 13px;
            opacity: 0.8;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ñ–∞–∫—Ç–∞ */
        .fact-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .fact-modal.active {
            display: flex;
        }

        .fact-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
        }

        .fact-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .fact-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .fact-close-btn {
            padding: 12px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* –ü–ª–∞–≤–∞—é—â–∏–µ —á–∏—Å–ª–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ */
        .float-number {
            position: fixed;
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        @keyframes floatUp {
            to {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <h1>üß† –§–∞–±—Ä–∏–∫–∞ –§–∞–∫—Ç–æ–≤</h1>
            <p>–°–æ–±–∏—Ä–∞–π –∑–Ω–∞–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–π —Ñ–∞–∫—Ç—ã!</p>
        </div>

        <!-- –°—á—ë—Ç—á–∏–∫ –∑–Ω–∞–Ω–∏–π -->
        <div class="knowledge-display">
            <div class="knowledge-amount" id="knowledgeAmount">0</div>
            <div class="knowledge-per-sec">
                üí° <span id="knowledgePerSec">0</span> –∑–Ω–∞–Ω–∏–π/—Å–µ–∫
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∫–ª–∏–∫–∞ -->
        <div class="click-button" id="clickButton">
            üí°
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="tabs">
            <button class="tab active" data-tab="shop">üè™ –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="tab" data-tab="leaders">üèÜ –õ–∏–¥–µ—Ä—ã</button>
            <button class="tab" data-tab="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ -->
        <div class="section active" id="shop">
            <div id="shopCards"></div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ -->
        <div class="section" id="leaders">
            <div id="leaderboard"></div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="section" id="info">
            <div class="card-item">
                <div class="card-info">
                    <div class="card-name">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</div>
                    <div class="card-stats">–ü–æ–ª—É—á–∏ 500 üí° –∑–∞ –∫–∞–∂–¥–æ–≥–æ</div>
                </div>
            </div>
            <div class="card-item">
                <div class="card-info">
                    <div class="card-name">üì¢ –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª</div>
                    <div class="card-stats">–ü–æ–ª—É—á–∏ 1000 üí° –±–æ–Ω—É—Å–æ–º</div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="inviteBtn">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                <button class="action-btn" id="channelBtn">üì¢ –ö–∞–Ω–∞–ª</button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–∞–∫—Ç–æ–º -->
        <div class="fact-modal" id="factModal">
            <div class="fact-content">
                <div class="fact-icon" id="factIcon">üéâ</div>
                <div class="fact-text" id="factText"></div>
                <button class="fact-close-btn" id="factCloseBtn">–ü–æ–Ω—è—Ç–Ω–æ!</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // ========================================
        
        const CONFIG = {
            CHANNEL_LINK: 'https://t.me/grehfacts',
            BOT_USERNAME: 'YourBotUsername', // –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ username –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
            REFERRAL_BONUS: 500,
            CHANNEL_BONUS: 1000
        };

        // ========================================
        // –î–ê–ù–ù–´–ï –ö–ê–†–¢–û–ß–ï–ö
        // ========================================
        
        const CARDS = [
            {
                id: 'basic',
                name: 'üìö –ó–∞–±–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç',
                cost: 50,
                income: 1,
                icon: 'üìö',
                facts: [
                    '–ú—ë–¥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ—Ä—Ç–∏—Ç—Å—è. –ê—Ä—Ö–µ–æ–ª–æ–≥–∏ –Ω–∞—Ö–æ–¥–∏–ª–∏ –≥–æ—Ä—à–∫–∏ —Å –º—ë–¥–æ–º –≤ –µ–≥–∏–ø–µ—Ç—Å–∫–∏—Ö –≥—Ä–æ–±–Ω–∏—Ü–∞—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–º 3000 –ª–µ—Ç!',
                    '–ë–∞–Ω–∞–Ω—ã ‚Äî —ç—Ç–æ —è–≥–æ–¥—ã, –∞ –∫–ª—É–±–Ω–∏–∫–∞ ‚Äî –Ω–µ—Ç. –ë–æ—Ç–∞–Ω–∏–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç –∏—Ö –ø–æ-–¥—Ä—É–≥–æ–º—É.',
                    '–û—Å—å–º–∏–Ω–æ–≥–∏ –∏–º–µ—é—Ç —Ç—Ä–∏ —Å–µ—Ä–¥—Ü–∞ –∏ –≥–æ–ª—É–±—É—é –∫—Ä–æ–≤—å!'
                ]
            },
            {
                id: 'science',
                name: 'üß† –ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç',
                cost: 300,
                income: 5,
                icon: 'üß†',
                facts: [
                    '–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –º–æ–∑–≥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 20% –≤—Å–µ–π —ç–Ω–µ—Ä–≥–∏–∏ —Ç–µ–ª–∞, —Ö–æ—Ç—è –≤–µ—Å–∏—Ç –≤—Å–µ–≥–æ 2% –æ—Ç –æ–±—â–µ–π –º–∞—Å—Å—ã.',
                    '–î–ù–ö —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ 50% —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –î–ù–ö –±–∞–Ω–∞–Ω–∞!',
                    '–°–≤–µ—Ç –æ—Ç –°–æ–ª–Ω—Ü–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –ó–µ–º–ª–∏ –∑–∞ 8 –º–∏–Ω—É—Ç 20 —Å–µ–∫—É–Ω–¥.'
                ]
            },
            {
                id: 'geography',
                name: 'üåç –ì–µ–æ–≥—Ä–∞—Ñ–∏—è',
                cost: 1000,
                income: 20,
                icon: 'üåç',
                facts: [
                    '–°–∞–º–∞—è –≥–ª—É–±–æ–∫–∞—è —Ç–æ—á–∫–∞ –æ–∫–µ–∞–Ω–∞ ‚Äî –ú–∞—Ä–∏–∞–Ω—Å–∫–∞—è –≤–ø–∞–¥–∏–Ω–∞ (11 –∫–º). –¢–∞–º –º–æ–∂–Ω–æ —Å–ø—Ä—è—Ç–∞—Ç—å –≠–≤–µ—Ä–µ—Å—Ç!',
                    '–†–æ—Å—Å–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 11 —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ ‚Äî –±–æ–ª—å—à–µ, —á–µ–º –ª—é–±–∞—è –¥—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞.',
                    '–í –°–∞—Ö–∞—Ä–µ –∏–Ω–æ–≥–¥–∞ –≤—ã–ø–∞–¥–∞–µ—Ç —Å–Ω–µ–≥!'
                ]
            },
            {
                id: 'discovery',
                name: 'üî¨ –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–∫–∞',
                cost: 5000,
                income: 100,
                icon: 'üî¨',
                facts: [
                    '–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏ —Å–ø–∞—Å–ª–∏ –±–æ–ª—å—à–µ –∂–∏–∑–Ω–µ–π, —á–µ–º –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏.',
                    '–ü–µ—Ä–≤—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä ENIAC –≤–µ—Å–∏–ª 27 —Ç–æ–Ω–Ω –∏ –∑–∞–Ω–∏–º–∞–ª —Ü–µ–ª—É—é –∫–æ–º–Ω–∞—Ç—É!',
                    '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥–ª—è –≤–æ–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π, –∞ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –≤ 1991 –≥–æ–¥—É.'
                ]
            },
            {
                id: 'encyclopedia',
                name: 'üéì –≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è',
                cost: 25000,
                income: 500,
                icon: 'üéì',
                facts: [
                    '–í–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π –±–æ–ª—å—à–µ –∑–≤—ë–∑–¥, —á–µ–º –ø–µ—Å—á–∏–Ω–æ–∫ –Ω–∞ –≤—Å–µ—Ö –ø–ª—è–∂–∞—Ö –ó–µ–º–ª–∏!',
                    '–ö–≤–∞–Ω—Ç–æ–≤–∞—è –∑–∞–ø—É—Ç–∞–Ω–Ω–æ—Å—Ç—å –ø–æ–∑–≤–æ–ª—è–µ—Ç —á–∞—Å—Ç–∏—Ü–∞–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –Ω–∞ –ª—é–±–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏.',
                    '–ß—ë—Ä–Ω—ã–µ –¥—ã—Ä—ã –∏—Å–∫—Ä–∏–≤–ª—è—é—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ-–≤—Ä–µ–º—è –Ω–∞—Å—Ç–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ, —á—Ç–æ –≤—Ä–µ–º—è —Ç–∞–º —Ç–µ—á—ë—Ç –ø–æ-–¥—Ä—É–≥–æ–º—É.'
                ]
            }
        ];

        // ========================================
        // –ò–ì–†–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
        // ========================================
        
        let gameState = {
            knowledge: 0,
            clickPower: 1,
            cards: {},
            totalClicks: 0,
            totalEarned: 0,
            userId: null,
            userName: '–ò–≥—Ä–æ–∫',
            referrerId: null,
            hasChannelBonus: false
        };

        // ========================================
        // TELEGRAM –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
        // ========================================
        
        const tg = window.Telegram?.WebApp;
        const isTelegram = !!tg?.initDataUnsafe?.user;

        if (isTelegram) {
            tg.expand();
            tg.ready();
            
            const user = tg.initDataUnsafe.user;
            gameState.userId = user.id.toString();
            gameState.userName = user.first_name || '–ò–≥—Ä–æ–∫';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
            const startParam = tg.initDataUnsafe.start_param;
            if (startParam && startParam !== gameState.userId) {
                gameState.referrerId = startParam;
                processReferral(startParam);
            }
            
            console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        // ========================================
        // –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–•
        // ========================================
        
        async function saveGame() {
            if (!gameState.userId) {
                localStorage.setItem('factoryGame', JSON.stringify(gameState));
                return;
            }

            try {
                await window.storage.set(
                    `user:${gameState.userId}`,
                    JSON.stringify(gameState)
                );
                console.log('‚úÖ –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                localStorage.setItem('factoryGame', JSON.stringify(gameState));
            }
        }

        async function loadGame() {
            if (!gameState.userId) {
                const saved = localStorage.getItem('factoryGame');
                if (saved) {
                    gameState = { ...gameState, ...JSON.parse(saved) };
                }
                return;
            }

            try {
                const result = await window.storage.get(`user:${gameState.userId}`);
                if (result && result.value) {
                    const saved = JSON.parse(result.value);
                    gameState = { ...gameState, ...saved };
                    console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫');
            }
        }

        async function saveToLeaderboard() {
            if (!gameState.userId) return;

            try {
                const income = calculateIncome();
                await window.storage.set(
                    `leader:${gameState.userId}`,
                    JSON.stringify({
                        name: gameState.userName,
                        knowledge: Math.floor(gameState.knowledge),
                        income: income,
                        timestamp: Date.now()
                    }),
                    true // shared = true –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                );
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ª–∏–¥–µ—Ä—ã:', error);
            }
        }

        async function loadLeaderboard() {
            try {
                const result = await window.storage.list('leader:', true);
                if (!result || !result.keys) return [];

                const leaders = [];
                for (const key of result.keys) {
                    try {
                        const data = await window.storage.get(key, true);
                        if (data && data.value) {
                            leaders.push(JSON.parse(data.value));
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–∞:', e);
                    }
                }

                return leaders.sort((a, b) => b.knowledge - a.knowledge).slice(0, 10);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–æ–≤:', error);
                return [];
            }
        }

        // ========================================
        // –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê
        // ========================================
        
        async function processReferral(referrerId) {
            try {
                const refKey = `ref:${referrerId}:${gameState.userId}`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª
                try {
                    await window.storage.get(refKey);
                    console.log('‚ÑπÔ∏è –†–µ—Ñ–µ—Ä–∞–ª —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω');
                    return;
                } catch (e) {
                    // –†–µ—Ñ–µ—Ä–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª
                await window.storage.set(refKey, JSON.stringify({
                    referrer: referrerId,
                    invited: gameState.userId,
                    date: new Date().toISOString()
                }));

                // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–º—É
                gameState.knowledge += CONFIG.REFERRAL_BONUS;
                await saveGame();

                // –£–≤–µ–¥–æ–º–ª—è–µ–º
                if (isTelegram) {
                    tg.showPopup({
                        title: 'üéâ –ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ!',
                        message: `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${CONFIG.REFERRAL_BONUS} üí° –∑–Ω–∞–Ω–∏–π!`,
                        buttons: [{ type: 'ok' }]
                    });
                }

                console.log('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞:', error);
            }
        }

        // ========================================
        // –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
        // ========================================
        
        function calculateIncome() {
            let income = 0;
            for (const cardId in gameState.cards) {
                const card = CARDS.find(c => c.id === cardId);
                if (card) {
                    income += card.income * gameState.cards[cardId];
                }
            }
            return income;
        }

        function buyCard(cardId) {
            const card = CARDS.find(c => c.id === cardId);
            if (!card) return;

            const currentCount = gameState.cards[cardId] || 0;
            const cost = Math.floor(card.cost * Math.pow(1.15, currentCount));

            if (gameState.knowledge >= cost) {
                gameState.knowledge -= cost;
                gameState.cards[cardId] = currentCount + 1;
                gameState.totalEarned += card.income;
                
                saveGame();
                saveToLeaderboard();
                updateUI();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∞–∫—Ç
                showRandomFact(card);
            }
        }

        function showRandomFact(card) {
            const fact = card.facts[Math.floor(Math.random() * card.facts.length)];
            const modal = document.getElementById('factModal');
            const icon = document.getElementById('factIcon');
            const text = document.getElementById('factText');
            
            icon.textContent = card.icon;
            text.textContent = fact;
            modal.classList.add('active');
        }

        function handleClick(event) {
            gameState.knowledge += gameState.clickPower;
            gameState.totalClicks++;
            
            // –ü–ª–∞–≤–∞—é—â–µ–µ —á–∏—Å–ª–æ
            const floatNum = document.createElement('div');
            floatNum.className = 'float-number';
            floatNum.textContent = `+${gameState.clickPower}`;
            floatNum.style.left = event.clientX + 'px';
            floatNum.style.top = event.clientY + 'px';
            document.body.appendChild(floatNum);
            
            setTimeout(() => floatNum.remove(), 1000);
            
            updateUI();
        }

        // ========================================
        // –ò–ù–¢–ï–†–§–ï–ô–°
        // ========================================
        
        function updateUI() {
            document.getElementById('knowledgeAmount').textContent = Math.floor(gameState.knowledge);
            document.getElementById('knowledgePerSec').textContent = calculateIncome();
            
            renderShop();
            saveGame();
        }

        function renderShop() {
            const container = document.getElementById('shopCards');
            container.innerHTML = '';
            
            CARDS.forEach(card => {
                const count = gameState.cards[card.id] || 0;
                const cost = Math.floor(card.cost * Math.pow(1.15, count));
                const canBuy = gameState.knowledge >= cost;
                
                const div = document.createElement('div');
                div.className = 'card-item';
                div.innerHTML = `
                    <div class="card-info">
                        <div class="card-name">${card.name}</div>
                        <div class="card-stats">+${card.income} üí°/—Å–µ–∫ ‚Ä¢ –¶–µ–Ω–∞: ${cost} üí°</div>
                        <div class="card-count">–ö—É–ø–ª–µ–Ω–æ: ${count}</div>
                    </div>
                    <button class="card-buy-btn" ${!canBuy ? 'disabled' : ''}>
                        –ö—É–ø–∏—Ç—å
                    </button>
                `;
                
                div.querySelector('button').onclick = () => buyCard(card.id);
                container.appendChild(div);
            });
        }

        async function renderLeaderboard() {
            const container = document.getElementById('leaderboard');
            container.innerHTML = '<div style="text-align:center;padding:20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            const leaders = await loadLeaderboard();
            
            if (leaders.length === 0) {
                container.innerHTML = '<div class="empty-state">üèÜ –ü–æ–∫–∞ –Ω–µ—Ç –ª–∏–¥–µ—Ä–æ–≤.<br>–°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }
            
            container.innerHTML = '';
            leaders.forEach((leader, index) => {
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                div.innerHTML = `
                    <div class="leader-rank">${['ü•á','ü•à','ü•â'][index] || `#${index + 1}`}</div>
                    <div class="leader-info">
                        <div class="leader-name">${leader.name}</div>
                        <div class="leader-score">${leader.knowledge} üí° ‚Ä¢ ${leader.income}/—Å–µ–∫</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ========================================
        // –°–û–ë–´–¢–ò–Ø
        // ========================================
        
        document.getElementById('clickButton').addEventListener('click', handleClick);
        
        document.getElementById('factCloseBtn').addEventListener('click', () => {
            document.getElementById('factModal').classList.remove('active');
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(target).classList.add('active');
                
                if (target === 'leaders') {
                    renderLeaderboard();
                }
            });
        });

        document.getElementById('inviteBtn').addEventListener('click', () => {
            if (!isTelegram || !gameState.userId) {
                alert('‚ö†Ô∏è –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Telegram');
                return;
            }
            
            const inviteLink = `https://t.me/${CONFIG.BOT_USERNAME}?start=${gameState.userId}`;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent('üß† –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –§–∞–±—Ä–∏–∫–µ –§–∞–∫—Ç–æ–≤! –°–æ–±–∏—Ä–∞–π –∑–Ω–∞–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã!')}`;
            
            tg.openTelegramLink(shareUrl);
        });

        document.getElementById('channelBtn').addEventListener('click', () => {
            if (isTelegram) {
                tg.openTelegramLink(CONFIG.CHANNEL_LINK);
            } else {
                window.open(CONFIG.CHANNEL_LINK, '_blank');
            }
        });

        // ========================================
        // –ü–ê–°–°–ò–í–ù–´–ô –î–û–•–û–î
        // ========================================
        
        setInterval(() => {
            const income = calculateIncome();
            if (income > 0) {
                gameState.knowledge += income;
                updateUI();
            }
        }, 1000);

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            saveGame();
            saveToLeaderboard();
        }, 10000);

        // ========================================
        // –ó–ê–ü–£–°–ö –ò–ì–†–´
        // ========================================
        
        (async function init() {
            await loadGame();
            updateUI();
            
            console.log('üß† –§–∞–±—Ä–∏–∫–∞ –§–∞–∫—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞!');
            console.log('üí° –ó–Ω–∞–Ω–∏–π:', gameState.knowledge);
            console.log('üìä –î–æ—Ö–æ–¥/—Å–µ–∫:', calculateIncome());
        })();
    </script>
</body>
</html>